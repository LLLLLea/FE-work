# 代理

代理是介于客户端与服务器之间的实体，它同时具备客户端和服务器的角色。

### 代理与网关的区别

严格的说，代理连接的是两个或多个使用`相同协议`的应用程序，而`网关`连接的则是两个或多个使用不同协议的端点。
网关扮演的是`协议转换器`的角色。例如，HTTP/POP网关就是http协议与pop协议进行转换，这样，可以通过
http协议读取Email邮件。但是在实际中，两者的区别很模糊，因为客户端和服务端通常会使用不同版本的HTTP协议，
因此代理也需要做一些协议转换工作。

### 代理的作用

- 儿童过滤器
- 文档访问控制
- 安全防火墙： 代理服务器会在网络中的单一安全节点上限制某些应用层协议的数据可以流入流出某一组织。还可以对流量进行检查来消除病毒
- web缓存： 维护经常访问文档的副本以加快访问速度
- 反向代理： 可以接受客户端的真实请求，但是反向代理与服务器不同的是，它们可以发起与其他服务器的请求，以便按需获取内容
- 内容服务器： 根据流量状况和内容类型将请求导向特定的服务器
- 转码器： 代理服务器在将内容发送给客户端之前，可以对内容的主体格式进行修改。例如传输gif格式图片时可以转为为jpg减小尺寸
- 匿名者： 代理服务器从HTTP报文中删除身份特性（例如客户端IP、From首部、Referrer首部、cookie等），从而提供高度的私密性和匿名性


### 代理服务器的部署

- 出口代理： 将代理固定在本地网络的出口点，以便控制本地网络与大型因特网之间的流量
- 入口（访问）代理： 通常放在ISP访问点上，用于处理来自客户的聚合请求
- 反向代理： 通常部署在网络边缘，在web服务器之前，作为替代物。它们可以处理所有传递给web服务器的请求，并在必要时
向服务器请求资源，可以提高服务器的安全性，或者将快速的web服务器缓存放在慢速的web服务器之前提高性能。反向代理通常
会冒用web服务器的名字和IP地址，这样所有请求都会被发送给代理而不是web服务器了
- 网络交换代理： 可以将具有足够处理能力的代理放在网络之间的因特网对等交换节点上，通过缓存来减轻节点拥塞，冰冷对流量进行监视

### 代理的工作机制：如何获取流量

- 修改客户端配置： 手工或自动修改客户端配置，这样客户端会有意将请求发送至代理服务器
- 修改网络： 这种被称为拦截代理，通过技术手段拦截网络流量并将其导入到代理
- 修改DNS的命名空间： 放在web服务器之前的替代物会直接假扮服务器的名称和IP，这样，可以手工编辑DNS列表，
或者用特殊的动态DNS服务器根据需要来确定适当的代理或服务器
- 修改web服务器： 可以修改web服务器的配置，向客户端发送一条重定向命令，重定向请求到一个代理上去

### 客户端的代理配置 

- 手动配置
- 预先配置浏览器： 浏览器发行厂商在将浏览器发送给客户使用之前配置
- 代理的自动配置（PAC，Proxy Auto-Configuration）：提供一个URI，指向一个用javascript编写的代理自动配置文件，
客户端会取回这个javascript文件，并运行它来决定是否使用代理和使用哪个代理。访问每个文档时，javascript函数都会选择适当的代理服务器
- WPAD的代理发现： 有些浏览器支持WPAD协议（Web Proxy Autodiscovery Protocol），这个协议会自动检测出浏览器可以
从哪个"配置服务器"下载到一个自动配置文件

### 追踪报文（Via首部）

web请求到达服务器时，可能会经过多个代理服务器。CDN就属于代理缓存。
使用`Via`首部可以记录报文途经的每个中间节点的信息，报文每经过一个节点，都必须将这个节点添加到Via首部的末尾。
 
    Via： 1.1 secure.proxy.net, 1.0 cache.proxy.net   
    表示：报文经过了两个代理，第一个实现了HTTP/1.1协议，第二个实现了HTTP/1.0协议
        

    


